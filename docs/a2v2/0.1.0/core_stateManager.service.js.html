<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/stateManager.service.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-branching.html">Branching Strategy</a></li><li><a href="tutorial-contributing_guide.html">Contributing Guide</a></li><li><a href="tutorial-getting_started.html">Getting Started</a></li><li><a href="tutorial-meta_documentation.html">Meta Documentation</a></li><li><a href="tutorial-modules.html">Modules</a></li><li><a href="tutorial-translations.html">Translations</a></li><li><a href="tutorial-user.html">User Guide</a></li></ul><h3>Modules</h3><ul><li><a href="app.common.module_modelManager.html">modelManager</a><ul class='methods'><li data-type='method'><a href="app.common.module_modelManager.html#~applyDefault">applyDefault</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~deleteColumns">deleteColumns</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~getSchema">getSchema</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~getSchema">getSchema</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~modifyPropNames">modifyPropNames</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~save">save</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~setDefault">setDefault</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~setModels">setModels</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~setSchema">setSchema</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~updateModel">updateModel</a></li></ul></li><li><a href="app.common.module_stateManager.html">stateManager</a><ul class='methods'><li data-type='method'><a href="app.common.module_stateManager.html#~addLink">addLink</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~addSpecific">addSpecific</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~buildStateTree">buildStateTree</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~existInStateModel">existInStateModel</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~findTitle">findTitle</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~getState">getState</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~getValidityValue">getValidityValue</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~goNoGoPreview">goNoGoPreview</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~isValid">isValid</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~listAdvanceHidden">listAdvanceHidden</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~reduceKey">reduceKey</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~reduceMapArray">reduceMapArray</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~removeNonExistent">removeNonExistent</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~searchUndefined">searchUndefined</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setAdvance">setAdvance</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setCustomTitles">setCustomTitles</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setItemId">setItemId</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setMapItemsState">setMapItemsState</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setMasterValidity">setMasterValidity</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setStateValueDown">setStateValueDown</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setStateValueUp">setStateValueUp</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setTitle">setTitle</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~uniqId">uniqId</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~updateSummaryForm">updateSummaryForm</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~updateSummaryFormMap">updateSummaryFormMap</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~updateValidity">updateValidity</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~validateModel">validateModel</a></li></ul></li><li><a href="app.geo.module_gapiService.html">gapiService</a><ul class='methods'><li data-type='method'><a href="app.geo.module_gapiService.html#~init">init</a></li></ul></li><li><a href="app.geo.module_layerService.html">layerService</a></li><li><a href="app.geo.module_projectionService.html">projectionService</a><ul class='methods'><li data-type='method'><a href="app.geo.module_projectionService.html#~projectExtent">projectExtent</a></li></ul></li><li><a href="app.layout.module_avAccordion.html">avAccordion</a><ul class='methods'><li data-type='method'><a href="app.layout.module_avAccordion.html#~addButton">addButton</a></li><li data-type='method'><a href="app.layout.module_avAccordion.html#~addIcon">addIcon</a></li><li data-type='method'><a href="app.layout.module_avAccordion.html#~avAccordion">avAccordion</a></li><li data-type='method'><a href="app.layout.module_avAccordion.html#~setAccordion">setAccordion</a></li></ul></li><li><a href="app.layout.module_avDragHandle.html">avDragHandle</a><ul class='methods'><li data-type='method'><a href="app.layout.module_avDragHandle.html#~avDragHandle">avDragHandle</a></li></ul></li><li><a href="app.layout.module_avFrame.html">avFrame</a><ul class='methods'><li data-type='method'><a href="app.layout.module_avFrame.html#~avFrame">avFrame</a></li></ul></li><li><a href="app.layout.module_avShell.html">avShell</a><ul class='methods'><li data-type='method'><a href="app.layout.module_avShell.html#~updateClass">updateClass</a></li></ul></li><li><a href="app.module_core.html">core</a><ul class='methods'><li data-type='method'><a href="app.module_core.html#~addButton">addButton</a></li><li data-type='method'><a href="app.module_core.html#~addTranslations">addTranslations</a></li><li data-type='method'><a href="app.module_core.html#~clickSubTab">clickSubTab</a></li><li data-type='method'><a href="app.module_core.html#~clickTab">clickTab</a></li><li data-type='method'><a href="app.module_core.html#~compile">compile</a></li><li data-type='method'><a href="app.module_core.html#~getLang">getLang</a></li><li data-type='method'><a href="app.module_core.html#~getLangs">getLangs</a></li><li data-type='method'><a href="app.module_core.html#~getNested">getNested</a></li><li data-type='method'><a href="app.module_core.html#~getUUID">getUUID</a></li><li data-type='method'><a href="app.module_core.html#~isArray">isArray</a></li><li data-type='method'><a href="app.module_core.html#~isObject">isObject</a></li><li data-type='method'><a href="app.module_core.html#~parseJSON">parseJSON</a></li><li data-type='method'><a href="app.module_core.html#~post">post</a></li><li data-type='method'><a href="app.module_core.html#~registerDebounce">registerDebounce</a></li><li data-type='method'><a href="app.module_core.html#~scrollToElement">scrollToElement</a></li><li data-type='method'><a href="app.module_core.html#~setExtensionDialog">setExtensionDialog</a></li><li data-type='method'><a href="app.module_core.html#~setLang">setLang</a></li><li data-type='method'><a href="app.module_core.html#~setLangs">setLangs</a></li><li data-type='method'><a href="app.module_core.html#~setUniq">setUniq</a></li><li data-type='method'><a href="app.module_core.html#~whatsThat">whatsThat</a></li></ul></li><li><a href="app.module_ui.html">ui</a><ul class='methods'><li data-type='method'><a href="app.module_ui.html#~copyValueToFormIndex">copyValueToFormIndex</a></li><li data-type='method'><a href="app.module_ui.html#~copyValueToModelIndex">copyValueToModelIndex</a></li><li data-type='method'><a href="app.module_ui.html#~findValues">findValues</a></li><li data-type='method'><a href="app.module_ui.html#~initValueToFormIndex">initValueToFormIndex</a></li><li data-type='method'><a href="app.module_ui.html#~resestShowAdvance">resestShowAdvance</a></li><li data-type='method'><a href="app.module_ui.html#~setErrorMessage">setErrorMessage</a></li><li data-type='method'><a href="app.module_ui.html#~setExtent">setExtent</a></li><li data-type='method'><a href="app.module_ui.html#~showAdvance">showAdvance</a></li><li data-type='method'><a href="app.module_ui.html#~toggleAll">toggleAll</a></li><li data-type='method'><a href="app.module_ui.html#~toggleSection">toggleSection</a></li><li data-type='method'><a href="app.module_ui.html#~updateLinkValues">updateLinkValues</a></li></ul></li><li><a href="app.ui.module_avBindValue.html">avBindValue</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avBindValue.html#~avBindValue">avBindValue</a></li></ul></li><li><a href="app.ui.module_avCompileHtml.html">avCompileHtml</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avCompileHtml.html#~avCompileHtml">avCompileHtml</a></li></ul></li><li><a href="app.ui.module_avContentPanel.html">avContentPanel</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avContentPanel.html#~addHeaderControl">addHeaderControl</a></li><li data-type='method'><a href="app.ui.module_avContentPanel.html#~initFooter">initFooter</a></li><li data-type='method'><a href="app.ui.module_avContentPanel.html#~link">link</a></li></ul></li><li><a href="app.ui.module_avHeader.html">avHeader</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avHeader.html#~avHeader">avHeader</a></li><li data-type='method'><a href="app.ui.module_avHeader.html#~create">create</a></li><li data-type='method'><a href="app.ui.module_avHeader.html#~filesSubmitted">filesSubmitted</a></li><li data-type='method'><a href="app.ui.module_avHeader.html#~getTemplates">getTemplates</a></li><li data-type='method'><a href="app.ui.module_avHeader.html#~save">save</a></li><li data-type='method'><a href="app.ui.module_avHeader.html#~save">save</a></li><li data-type='method'><a href="app.ui.module_avHeader.html#~setLanguage">setLanguage</a></li><li data-type='method'><a href="app.ui.module_avHeader.html#~setTemplate">setTemplate</a></li></ul></li><li><a href="app.ui.module_avLanguage.html">avLanguage</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avLanguage.html#~avLanguage">avLanguage</a></li></ul></li><li><a href="app.ui.module_avMap.html">avMap</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avMap.html#~avMap">avMap</a></li><li data-type='method'><a href="app.ui.module_avMap.html#~setCollapsibleHeader">setCollapsibleHeader</a></li><li data-type='method'><a href="app.ui.module_avMap.html#~setCollapsibleHeaderEntry">setCollapsibleHeaderEntry</a></li></ul></li><li><a href="app.ui.module_avServices.html">avServices</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avServices.html#~avServices">avServices</a></li></ul></li><li><a href="app.ui.module_avSummary.html">avSummary</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avSummary.html#~avSummary">avSummary</a></li><li data-type='method'><a href="app.ui.module_avSummary.html#~expandSummary">expandSummary</a></li><li data-type='method'><a href="app.ui.module_avSummary.html#~initState">initState</a></li><li data-type='method'><a href="app.ui.module_avSummary.html#~openPreview">openPreview</a></li><li data-type='method'><a href="app.ui.module_avSummary.html#~previewReady">previewReady</a></li><li data-type='method'><a href="app.ui.module_avSummary.html#~setSubTab">setSubTab</a></li><li data-type='method'><a href="app.ui.module_avSummary.html#~setSubTabID">setSubTabID</a></li><li data-type='method'><a href="app.ui.module_avSummary.html#~walkTree">walkTree</a></li></ul></li><li><a href="app.ui.module_avTab.html">avTab</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avTab.html#~avTab">avTab</a></li><li data-type='method'><a href="app.ui.module_avTab.html#~mapTabs">mapTabs</a></li></ul></li><li><a href="app.ui.module_avTest.html">avTest</a></li><li><a href="app.ui.module_avTree.html">avTree</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avTree.html#~avTree">avTree</a></li></ul></li><li><a href="app.ui.module_avUi.html">avUi</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avUi.html#~avUi">avUi</a></li><li data-type='method'><a href="app.ui.module_avUi.html#~getAboutChoice">getAboutChoice</a></li></ul></li><li><a href="app.ui.module_avVersion.html">avVersion</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avVersion.html#~avVersion">avVersion</a></li></ul></li><li><a href="app.ui.module_dynamicSelect.html">dynamicSelect</a><ul class='methods'><li data-type='method'><a href="app.ui.module_dynamicSelect.html#~dynamicSelect">dynamicSelect</a></li></ul></li><li><a href="material.components.button.module_MdButtonDirectiveDecorator.html">MdButtonDirectiveDecorator</a><ul class='methods'><li data-type='method'><a href="material.components.button.module_MdButtonDirectiveDecorator.html#~decorateCompile">decorateCompile</a></li></ul></li><li><a href="material.components.tooltip.module_mdTooltipDirective.html">mdTooltipDirective</a><ul class='methods'><li data-type='method'><a href="material.components.tooltip.module_mdTooltipDirective.html#~decorateCompile">decorateCompile</a></li><li data-type='method'><a href="material.components.tooltip.module_mdTooltipDirective.html#~isTouch">isTouch</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="app.html">app</a></li><li><a href="app.addon.html">addon</a></li><li><a href="app.core.html">core</a><ul class='methods'><li data-type='method'><a href="app.core.html#.configBlock">configBlock</a></li><li data-type='method'><a href="app.core.html#.seed">seed</a></li><li data-type='method'><a href="app.core.html#~configureIconsets">configureIconsets</a></li><li data-type='method'><a href="app.core.html#~configureTheme">configureTheme</a></li><li data-type='method'><a href="app.core.html#~configureTranslations">configureTranslations</a></li></ul></li><li><a href="app.geo.html">geo</a></li><li><a href="app.layout.html">layout</a></li><li><a href="app.ui.html">ui</a></li></ul><h3>Global</h3><ul><li><a href="global.html#$on">$on</a></li><li><a href="global.html#applyDefault">applyDefault</a></li><li><a href="global.html#AV">AV</a></li><li><a href="global.html#avDefaults">avDefaults</a></li><li><a href="global.html#compile">compile</a></li><li><a href="global.html#configureParser">configureParser</a></li><li><a href="global.html#initLanguages">initLanguages</a></li><li><a href="global.html#initShortcut">initShortcut</a></li><li><a href="global.html#loadExtensions">loadExtensions</a></li><li><a href="global.html#uploadDefault">uploadDefault</a></li><li><a href="global.html#uploadSchema">uploadSchema</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">core/stateManager.service.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module stateManager
 * @memberof app.common
 * @description
 *
 * The `stateManager` factory is a service controlling states content.
 *
 */
angular
    .module('app.core')
    .factory('stateManager', stateManager);

function stateManager($timeout, $translate, events, constants, commonService, modelManager) {

    const service = {
        getState,
        goNoGoPreview,
        validateModel
    };

    const _state = {};

    return service;

    /*********/

    /**
     * Get state object
     * @function getState
     * @param {Object} modelName the model/form name to get state on
     * @return {Object}          the state object in JSON
     */
    function getState(modelName) {
        const link = constants.schemas
            .indexOf(`${modelName}.[lang].json`) + 1;
        // create state object used by the summary section
        _state[modelName] = { 'key': modelName,
            'title': $translate.instant(`app.section.${modelName}`),
            'valid': null,
            'expand': false,
            'masterlink': link,
            'hlink': link,
            'advance': false,
            'stype': '',
            'shlink': '',
            items: [] };

        return _state[modelName];
    }

    /**
     * Check validity of state sections
     * @function goNoGoPreview
     * @return {Boolean}  the go or no go
     */
    function goNoGoPreview() {
        let goNoGo = false; // Default

        // State defined
        if (Object.keys(_state).length === 0
                    &amp;&amp; _state.constructor === Object) {
            goNoGo = false;
        } else {
            let validity = [];
            const names = Object.getOwnPropertyNames(_state);
            for (let item of names) {
                validity.push(_state[item].valid);
            }
            goNoGo = !(validity.includes(false) || validity.includes(null));
        }

        return goNoGo;
    }

    /**
     * Set state object with valid values from the form field validity
     * @function validateModel
     * @param {String}  modelName the model/form name to get state on
     * @param {Object}  form      the angular schema form active form
     * @param {Array}   arrForm   the form as an array of objects
     * @param {Object}  model     the model
     */
    function validateModel(modelName, form, arrForm, model) {

        const cleanForm = commonService.parseJSON(form);

        // Since map is much more complicated we isolate it
        if (modelName === 'map') {
            const arrKeys = updateSummaryFormMap(_state[modelName], modelName, cleanForm);

            // Generate state records for basemaps, layers, tileSchemas, extentSets and lodSets
            setMapItemsState(_state[modelName], model, arrKeys);
        } else {
            updateSummaryForm(_state[modelName], modelName, cleanForm);
        }

        // TITLE SECTION
        // Set each title
        setTitle(_state[modelName], arrForm);

        // Set custom title
        setCustomTitles(_state[modelName], modelName);

        // VALIDITY SECTION
        // Set master element validity
        setMasterValidity(_state[modelName]);

        // UNDEFINED SECTION
        // Undefined parameters
        let modKeys = [modelName];
        let modUndef = [];
        searchUndefined(modKeys, model, modUndef);

        // Remove keys that are not in the stateModel
        // eg. both about.content and about.folderName exist in the model
        // but just one in the stateModel. This is caused by the way we managed JSON schema 'OneOf'
        // Should not be applied on list of elements [tileSchemas, extents, lods, basemaps, layers]
        if (modelName === 'ui') {
            let modUndefExist = [];
            // Special case where we have to add aboutChoice key;
            for (let i of modUndef) {
                if (i[0].includes('about')) {
                    const index = i[0].indexOf('about') + 1;
                    i[0].splice(index, 0, 'aboutChoice');
                }
            }
            removeNonExistent(_state[modelName], modelName, modUndef, modUndefExist);
            updateValidity(_state[modelName], modelName, modUndefExist);
        } else {
            // Update validity based on undefined
            updateValidity(_state[modelName], modelName, modUndef);
        }


        // ADVANCE SECTION
        // Advance parameters
        let adv = [];
        listAdvanceHidden(arrForm, adv);
        const advHidden = [].concat.apply([], adv);

        // Set special style to hidden advance parameter
        setAdvance(_state[modelName], modelName, advHidden);
    }

    /**
     * Remove keys if they don't exist in the stateModel
     * @function removeNonExistent
     * @private
     * @param {Object}  stateModel the stateModel
     * @param {String}  modelName modelName
     * @param {Array}   keysIn list of original keys [[keys], valid]
     * @param {Array}   keysOut list of update keys [[keys], valid]
     */
    function removeNonExistent(stateModel, modelName, keysIn, keysOut) {

        const keysInUpd = addSpecific(keysIn, modelName);

        for (let keys of keysInUpd) {
            let keysCheck = keys[0].slice();
            keysCheck.unshift(modelName);
            let exist = [];
            existInStateModel(stateModel, keysCheck, exist);
            if (exist.includes(true)) keysOut.push(keys);
        }
    }

    /**
     * Look for the existence of a path in the stateModel
     * @function existInStateModel
     * @private
     * @param {Object}  stateModel the stateModel
     * @param {Array}   keys set of keys defining a path
     * @param {Array} exist true if the path exist
     */
    function existInStateModel(stateModel, keys, exist) {

        if (stateModel.key === keys[0]) {
            keys.shift();
            if (keys.length === 0) {
                exist.push(true);
            } else if (stateModel.hasOwnProperty('items')) {
                for (let item of stateModel.items) {
                    if (keys[0] === item.key) existInStateModel(item, keys, exist);
                }
            }
        }
    }

    /**
     * Set advance parameter in state model
     * All element and sub-element will have 'advance' parameter
     * set to true
     * @function setAdvance
     * @private
     * @param {Object}  stateModel the stateModel
     * @param {String}  modelName modelName
     * @param {Array}   arrKeys list of advance parameter keys
     */
    function setAdvance(stateModel, modelName, arrKeys) {
        if (arrKeys.includes(stateModel.key)) {
            setStateValueDown(stateModel, 'advance', true)
        } else if (stateModel.hasOwnProperty('items')) {
            for (let item of stateModel.items) {
                setAdvance(item, modelName, arrKeys);
            }
        }
    }

    /**
     * Set a parameter value for an element of the state model
     * and all is children
     * @function setStateValueDown
     * @private
     * @param {Object}  stateModel the stateModel
     * @param {String}  param parameter name
     * @param {Object}  value value to give to parameter
     */
    function setStateValueDown(stateModel, param, value) {

        stateModel[param] = value;

        if (stateModel.hasOwnProperty('items')) {
            for (let item of stateModel.items) {
                setStateValueDown(item, param, value);
            }
        }
    }

    /**
     * Set a parameter value for an element of the state model
     * and all parents
     * @function setStateValueUp
     * @private
     * @param {Object}  stateModel the stateModel
     * @param {Array}  path path from root to element ['root','child','grandchild=element']
     * @param {String}  param parameter name
     * @param {Object}  value value to give to parameter
     */
    function setStateValueUp(stateModel, path, param, value) {

        stateModel[param] = value;
        const target = path.shift();
        if (path.length > 0) {
            // Find proper target place
            for (let [j, item] of stateModel.items.entries()) {
                // Check if the target is a number
                // if so compare with index instead of key
                const isNumber = !isNaN(target);

                if ((isNumber &amp;&amp; j === parseInt(target)) || item.key === target) {
                    setStateValueUp(stateModel.items[j], path, param, value);
                }
            }
        }
    }

    /**
     * List undefined attributes
     * @function  searchUndefined
     * @private
     * @param {Array}   modelKeys the model name path
     * @param {Object}  model the model
     * @param {Array}   arrKeys array of keys
     */
    function searchUndefined(modelKeys, model, arrKeys) {

        const dataType = commonService.whatsThat(model);

        if (dataType === 'undefined') {
            modelKeys.shift();
            arrKeys.push([modelKeys, false]);
        } else if(dataType !== 'null') {
            const entries = Object.entries(model);

            for (let el of entries) {
                if (dataType === 'array' || dataType === 'object') {
                    const keys = modelKeys.concat(el[0]);
                    searchUndefined(keys, el[1], arrKeys);
                }
            }
        }
    }

    /**
     * Set undefined parameter in state model and update
     * validity of upper hierarchy
     * @function updateValidity
     * @private
     * @param {Object}  stateModel the stateModel
     * @param {String}  modelName modelName
     * @param {Array}   undefKeys list of advance parameter keys
     */
    function updateValidity(stateModel, modelName, undefKeys) {
        const keysArrUpd = addSpecific(undefKeys, modelName);

        for (let k of keysArrUpd) {
            const path = k[0];
            setStateValueUp(stateModel, path, 'valid', false);
        }
    }

    /**
     * Set new record for map items in state model
     * @function setMapItemsState
     * @private
     * @param {Object}  stateModel the stateModel
     * @param {Object}  model the model
     * @param {Array} arrKeys array of object {key: [], valid: true | false}
     */
    function setMapItemsState(stateModel, model, arrKeys) {

        // baseMaps and layers
        const setNames = [[2,'baseMaps'], [3, 'layers']];
        const masterLink = constants.schemas
            .indexOf(`map.[lang].json`) + 1;

        for (let i of setNames) {
            const items = model[i[1]];
            const hlink = constants.subTabs.map.keys[i[0]].replace(/\./g, '-');

            stateModel.items[i[0]]['items'] = [];

            for (let [j, item] of items.entries()) {
                const shlink = setItemId(hlink, i[1], j);

                stateModel.items[i[0]]['items']
                    .push({ 'key': item.name,
                        'title': item.name,
                        items: [],
                        'valid': true,
                        'expand': false,
                        'masterlink': masterLink,
                        'hlink': hlink,
                        'advance': false,
                        'stype': 'element',
                        'shlink': shlink,
                        'type': 'object' });
            }
        }

        // tilesSchemas, extents, lods
        const setID = [[0,'tileSchemas', 'name'], [1, 'extentSets', 'id'], [2, 'lodSets', 'id']];

        for (let i of setID) {
            const items = model[i[1]];
            const hlink = constants.subTabs.map.keys[0].replace(/\./g, '-');

            stateModel.items[0].items[i[0]]['items'] = [];

            for (let item of items) {
                stateModel.items[0].items[i[0]]['items']
                    .push({ 'key': item[i[2]],
                        'title': item[i[2]],
                        items: [],
                        'valid': true,
                        'expand': false,
                        'masterlink': masterLink,
                        'hlink': hlink,
                        'advance': false,
                        'stype': 'element',
                        'shlink': '',
                        'type': 'object' });
            }
        }

    }

    /**
     * Get validity from an item in a list
     * Currently works only with baseMaps, layers, tileSchemas, extentSets, lodSets
     * @function getValidityValue
     * @private
     * @param {String} key key to select the proper list
     * @param {Number} index index in the form
     * @param {Array} arrKeys array of object {key: [], valid: true | false}
     * @return {Boolean} validity
     */
    function getValidityValue(key, index, arrKeys) {

        const validKey = arrKeys.filter(el => el[0][0] === key &amp;&amp; el[0][1] === index.toString()).slice();
        const validArr = validKey.map(el => {
            el = el.slice(1);
            return el;
        }).slice();

        return !validArr.includes(false);
    }

    /**
     * List of hidden advance parameters
     * @function listAdvanceHidden
     * @private
     * @param {Array}   arrForm   the form as an array of objects
     * @param {Array}   list   list of hidden advance parameters
     */
    function listAdvanceHidden(arrForm, list) {

        arrForm.forEach(item => {
            if (item.hasOwnProperty('htmlClass') &amp;&amp; item.htmlClass === 'av-form-advance hidden') {
                list.push(item.key);
            }
            if (item.hasOwnProperty('items')) {
                listAdvanceHidden(item.items, list);
            }
        });
    }

    /**
     * Retrieve the title corresponding to the provided key
     * @function setTitle
     * @private
     * @param {Object}  stateModel the stateModel
     * @param {Array}   arrForm   the form as an array of objects
     */
    function setTitle(stateModel, arrForm) {

        if (stateModel.hasOwnProperty('key') &amp;&amp; stateModel.title === '') {
            findTitle(stateModel.key, stateModel, arrForm);
        }
        if (stateModel.hasOwnProperty('items')) {
            stateModel.items.forEach(item => {
                setTitle(item, arrForm);
            });
        }
    }

    /**
     * Retrieve the title corresponding to the provided key
     * @function setCustomTitles
     * @private
     * @param {Object}  stateModel the stateModel
     * @param {String}   modelName modelName
     */
    function setCustomTitles(stateModel, modelName) {
        const customTitles = {
            'map': ['form.map.extentlods'],
            'ui': ['form.ui.general', 'form.ui.nav', 'form.ui.sidemenu'],
            'services': ['form.service.urls'],
            'language': [],
            'version': []
        };

        customTitles[modelName].forEach(title => {
            if (stateModel.hasOwnProperty('key') &amp;&amp; stateModel.key === title) {
                stateModel.title = $translate.instant(title);
            }
            if (stateModel.hasOwnProperty('items')) {
                stateModel.items.forEach(item => {
                    setCustomTitles(item, modelName);
                });
            }
        });
    }

    /**
     * Search for the title corresponding to the provided key
     * Ref: https://stackoverflow.com/questions/7837456/how-to-compare-arrays-in-javascript?page=1&amp;tab=votes#tab-top
     * @function findTitle
     * @private
     * @param {key}     key the key to look for (could be an array)
     * @param {Object}  itemForm a form item
     * @param {Array}   arrForm the form as an array of objects
     */
    function findTitle(key, itemForm, arrForm) {

        arrForm.forEach(item => {
            if (item.hasOwnProperty('key')) {
                if (Array.isArray(item.key)) {
                    if (key === item.key[item.key.length - 1]) {
                        itemForm.title = item.title;
                    }
                } else if (key === item.key) {
                    itemForm.title = item.title;
                }
            }
            if (item.hasOwnProperty('items')) {
                findTitle(key, itemForm, item.items);
            }
        });
    }

    /**
     * Create state object from model/form for the map section of the summary panel
     * @function updateSummaryFormMap
     * @private
     * @param {Object} state the state object in JSON
     * @param {String} modelName the current model name
     * @param {Object} form the form object in JSON
     * @return {Array} arrKeys array of object {key: [], valid: true | false}
     */
    function updateSummaryFormMap(state, modelName, form) {

        let keysArr = [];

        // loop trough form keys to create set of keys
        $.each(form, key => {
            if (key.startsWith('activeForm-')) {
                // get all the keys to find the object
                let keys = key.replace('--', '-').split('-').filter(n => n !== '' &amp;&amp; n!== 'activeForm');

                // remove first element of keys set if it is '0'
                if (keys [0] === '0') keys.shift();

                keysArr.push([keys, form[key].$valid]);
            }
        });

        // Simplify keys set
        const keysArrRed = reduceMapArray(keysArr);
        const keysArrUpd = addSpecific(keysArrRed, modelName);

        const link = constants.schemas
            .indexOf(`${modelName}.[lang].json`) + 1;

        addLink(keysArrUpd);

        buildStateTree(state, modelName, keysArrUpd, link);

        return keysArr;
    }

    /**
     * Create state object from model/form for the summary panel
     * @function updateSummaryForm
     * @private
     * @param {Object} state the state object in JSON
     * @param {String} modelName the current model name
     * @param {Object} form the form object in JSON
     * @param {Object} list hidden advance parameters list
     */
    function updateSummaryForm(state, modelName, form) {

        let keysArr = [];
        // loop trough form keys to create set of keys
        $.each(form, key => {
            if (key.startsWith('activeForm-')) {
                // get all the keys to find the object
                let keys = key.split('-').filter(n => n !== '' &amp;&amp; n!== 'activeForm');

                // remove duplicate keys. They are introduce by array in schema form
                const unique = commonService.setUniq(keys);

                keysArr.push([unique, form[key].$valid]);
            }
        });

        // Add specific keys so the missing tabs can be represented in the summary
        const keysArrUpdate = addSpecific(keysArr, modelName);

        const link = constants.schemas
            .indexOf(`${modelName}.[lang].json`) + 1;

        addLink(keysArr);

        buildStateTree(state, modelName, keysArr, link);
    }

    /**
     * Create state object from model/form for the summary panel
     * @function buildStateTree
     * @private
     * @param {Object} state the state object in JSON
     * @param {String} element the current element name
     * @param {Array} arrKeys array of arrays [[keys], valid: true | false, hlink: 'id']
     * @param {Number} mainSection ['map':1 | 'ui':2 | 'services':3 | 'version':4 | 'language':5]
     */
    function buildStateTree(state, element, arrKeys, mainSection) {

        // SubTab link
        let hlink = mainSection;

        const firstItems = [];
        arrKeys.forEach(arr => firstItems.push(arr[0][0]));
        const firstItemsUniq = Array.from(new Set(firstItems));

        for (let item of firstItemsUniq) {

            const validKey = arrKeys.filter(el => el[0][0] === item).slice();

            const maxLen = Math.max(arrKeys.filter(el => el[0][0] === item).length);
            // Check if we need to add items attribute
            if (maxLen > 1 &amp;&amp; item !== 'items') {

                // Validity
                const validState = isValid(validKey);

                // Link
                const hlink = uniqId(validKey).replace(/\./g, '-');

                state.items
                    .push({ 'key': item,
                        'title': '',
                        items: [],
                        'valid': validState,
                        'expand': false,
                        'masterlink': mainSection,
                        'hlink': hlink,
                        'advance': false,
                        'stype': '',
                        'shlink': '',
                        'type': 'object' });

                // Build new keys array
                const newKeysArr = arrKeys.filter(el => {
                    if (el[0][0] === item) {
                        el[0].shift();
                        return el;
                    }
                });

                const index = state.items.findIndex(el => el.key === item);
                // Go deeper
                buildStateTree(state.items[index], item, newKeysArr, mainSection);
            } else if (item !== 'items' &amp;&amp; typeof item !== 'undefined') {

                // validKey => [[[key], valid, id]]
                const valid = validKey[0][1];

                const index = constants.schemas.indexOf(`${validKey[0][2]}.[lang].json`);
                const hlink = index === -1 ? validKey[0][2].replace(/\./g, '-') : mainSection;

                state.items
                    .push({ 'key': item,
                        'title': '',
                        'valid': valid,
                        'expand': false,
                        'masterlink': mainSection,
                        'hlink': hlink,
                        'advance': false,
                        'stype': '',
                        'shlink': '',
                        'type': 'object' });
            }
        }
    }

    /**
     * Add hyperlink to arrays of key. The hyperlink === first key of keys array
     * @function addLink
     * @private
     * @param {Array} arrKeys array of arrays [[keys], valid: true | false, hlink: 'id']
     */
    function addLink(arrKeys) {
        for (let i of arrKeys) {
            i.push(i[0][0]);
        }
    }

    /**
     * Set the item id in the DOM and return the id
     * @function setItemId
     * @private
     * @param {String} hlink subTab link
     * @param {String} elType element type {'baseMaps'|'layers'}
     * @param {Number} index rank in elements list
     * @return {String} id
     */
    function setItemId(hlink, elType, index) {
        const el = angular.element(`#${hlink}-pane`);
        const children = Array.from(el[0].querySelector("ol").children);

        const id = `${elType}-${index}`;
        children[index].setAttribute('id', id);
        return id;
    }

    /**
     * Return a unique id
     * @function uniqId
     * @private
     * @param {Array} arrKeys array of arrays [[keys], valid: true | false, hlink: 'id']
     * @return {String} id
     */
    function uniqId(arrKeys) {
        const ids = [];
        for (let i of arrKeys) ids.push(i[2]);
        const id = commonService.setUniq(ids);
        if (id.length !== 1) {
            console.log('ERROR: MULTIPLE IDS');
        }

        return id[0];
    }

    /**
     * Return validity
     * @function isValid
     * @private
     * @param {Array} arrKeys array of arrays [[keys], valid: true | false, hlink: 'id']
     * @return {Boolean} return false if there's at least one false in validity array
     */
    function isValid(arrKeys) {
        const valid = [];
        for (let i of arrKeys) valid.push(i[1]);
        return !valid.includes(false);
    }

    /**
     * Reduce map array to simplify hierarchy
     * @function reduceMapArray
     * @private
     * @param {Array} arrKeys array of object {key: [], valid: true | false}
     * @return {Array} reduced keys array
     */
    function reduceMapArray(arrKeys) {

        const arrLegend = arrKeys.filter(el => el[0][0] === 'legend');
        const arrComp = arrKeys.filter(el => el[0][0] === 'components');

        const arr = reduceKey(arrKeys, ['tileSchemas'])
            .concat(reduceKey(arrKeys, ['extentSets']),
                reduceKey(arrKeys, ['lodSets']),
                arrComp,
                reduceKey(arrKeys, ['baseMaps']),
                reduceKey(arrKeys, ['layers']),
                arrLegend
            );

        return arr;
    }

    /**
     * Reduce map array to simplify hierarchy
     * @function reduceKey
     * @private
     * @param {Array} arrKeys array of object {key: [], valid: true | false}
     * @param {Array} keys keys
     * @return {Array} reduced keys array
     */
    function reduceKey(arrKeys, keys) {

        const arr = arrKeys.filter(el => el[0].length >= keys.length
                                        &amp;&amp; keys.every((v,i) => v === el[0][i]));

        const validSet = [];
        for (let i of arr) validSet.push(i[1]);
        const valid = !validSet.includes(false);

        return [[keys,valid]];
    }

    /**
     * Add specific keys so missing tabs can be part of the summary
     * @function addSpecific
     * @private
     * @param {Array}   arrKeys array of object {key: [], valid: true | false}
     * @param {String}  modelName modelName
     * @return {Array} updated keys array
     */
    function addSpecific(arrKeys, modelName) {
        const keys = {
            'map': { 'form.map.extentlods': ['tileSchemas', 'extentSets', 'lodSets'] },
            'ui': { 'form.ui.general': ['fullscreen', 'theme', 'legend', 'tableIsOpen', 'failureFeedback'],
                'form.ui.nav': ['restrictNavigation', 'navBar'],
                'form.ui.sidemenu': ['sideMenu', 'logoUrl', 'title', 'help', 'about']
            },
            'services': { 'form.service.urls': ['exportMapUrl', 'geometryUrl', 'googleAPIKey', 'proxyUrl'] },
            'language': {},
            'version': {}
        };

        arrKeys.forEach(key => {
            Object.keys(keys[modelName]).forEach(skey => {
                if (keys[modelName][skey].includes(key[0][0])) {
                    key[0].unshift(skey);
                }
            });
        });

        return arrKeys;
    }

    /**
     * Set validity on master element of the model
     * @function setMasterValidity
     * @private
     * @param {Object} state the state object in JSON
     */
    function setMasterValidity(state) {

        const validSet = [];

        for (let i of state.items) validSet.push(i.valid);

        state.valid = !validSet.includes(false);
    }
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Feb 15 2018 14:54:04 GMT-0500 (EST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>

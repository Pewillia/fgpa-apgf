<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/modelManager.service.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-branching.html">Branching Strategy</a></li><li><a href="tutorial-contributing_guide.html">Contributing Guide</a></li><li><a href="tutorial-getting_started.html">Getting Started</a></li><li><a href="tutorial-meta_documentation.html">Meta Documentation</a></li><li><a href="tutorial-modules.html">Modules</a></li><li><a href="tutorial-translations.html">Translations</a></li><li><a href="tutorial-user.html">User Guide</a></li></ul><h3>Modules</h3><ul><li><a href="app.common.module_modelManager.html">modelManager</a><ul class='methods'><li data-type='method'><a href="app.common.module_modelManager.html#~applyDefault">applyDefault</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~deleteColumns">deleteColumns</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~getSchema">getSchema</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~getSchema">getSchema</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~modifyPropNames">modifyPropNames</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~save">save</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~setDefault">setDefault</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~setModels">setModels</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~setSchema">setSchema</a></li><li data-type='method'><a href="app.common.module_modelManager.html#~updateModel">updateModel</a></li></ul></li><li><a href="app.common.module_stateManager.html">stateManager</a><ul class='methods'><li data-type='method'><a href="app.common.module_stateManager.html#~addLink">addLink</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~addSpecific">addSpecific</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~buildStateTree">buildStateTree</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~existInStateModel">existInStateModel</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~findTitle">findTitle</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~getState">getState</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~getValidityValue">getValidityValue</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~goNoGoPreview">goNoGoPreview</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~isValid">isValid</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~listAdvanceHidden">listAdvanceHidden</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~reduceKey">reduceKey</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~reduceMapArray">reduceMapArray</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~removeNonExistent">removeNonExistent</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~searchUndefined">searchUndefined</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setAdvance">setAdvance</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setCustomTitles">setCustomTitles</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setItemId">setItemId</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setMapItemsState">setMapItemsState</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setMasterValidity">setMasterValidity</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setStateValueDown">setStateValueDown</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setStateValueUp">setStateValueUp</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~setTitle">setTitle</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~uniqId">uniqId</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~updateSummaryForm">updateSummaryForm</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~updateSummaryFormMap">updateSummaryFormMap</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~updateValidity">updateValidity</a></li><li data-type='method'><a href="app.common.module_stateManager.html#~validateModel">validateModel</a></li></ul></li><li><a href="app.geo.module_gapiService.html">gapiService</a><ul class='methods'><li data-type='method'><a href="app.geo.module_gapiService.html#~init">init</a></li></ul></li><li><a href="app.geo.module_layerService.html">layerService</a></li><li><a href="app.geo.module_projectionService.html">projectionService</a><ul class='methods'><li data-type='method'><a href="app.geo.module_projectionService.html#~projectExtent">projectExtent</a></li></ul></li><li><a href="app.layout.module_avAccordion.html">avAccordion</a><ul class='methods'><li data-type='method'><a href="app.layout.module_avAccordion.html#~addButton">addButton</a></li><li data-type='method'><a href="app.layout.module_avAccordion.html#~addIcon">addIcon</a></li><li data-type='method'><a href="app.layout.module_avAccordion.html#~avAccordion">avAccordion</a></li><li data-type='method'><a href="app.layout.module_avAccordion.html#~setAccordion">setAccordion</a></li></ul></li><li><a href="app.layout.module_avDragHandle.html">avDragHandle</a><ul class='methods'><li data-type='method'><a href="app.layout.module_avDragHandle.html#~avDragHandle">avDragHandle</a></li></ul></li><li><a href="app.layout.module_avFrame.html">avFrame</a><ul class='methods'><li data-type='method'><a href="app.layout.module_avFrame.html#~avFrame">avFrame</a></li></ul></li><li><a href="app.layout.module_avShell.html">avShell</a><ul class='methods'><li data-type='method'><a href="app.layout.module_avShell.html#~updateClass">updateClass</a></li></ul></li><li><a href="app.module_core.html">core</a><ul class='methods'><li data-type='method'><a href="app.module_core.html#~addButton">addButton</a></li><li data-type='method'><a href="app.module_core.html#~addTranslations">addTranslations</a></li><li data-type='method'><a href="app.module_core.html#~clickSubTab">clickSubTab</a></li><li data-type='method'><a href="app.module_core.html#~clickTab">clickTab</a></li><li data-type='method'><a href="app.module_core.html#~compile">compile</a></li><li data-type='method'><a href="app.module_core.html#~getLang">getLang</a></li><li data-type='method'><a href="app.module_core.html#~getLangs">getLangs</a></li><li data-type='method'><a href="app.module_core.html#~getNested">getNested</a></li><li data-type='method'><a href="app.module_core.html#~getUUID">getUUID</a></li><li data-type='method'><a href="app.module_core.html#~isArray">isArray</a></li><li data-type='method'><a href="app.module_core.html#~isObject">isObject</a></li><li data-type='method'><a href="app.module_core.html#~parseJSON">parseJSON</a></li><li data-type='method'><a href="app.module_core.html#~post">post</a></li><li data-type='method'><a href="app.module_core.html#~registerDebounce">registerDebounce</a></li><li data-type='method'><a href="app.module_core.html#~scrollToElement">scrollToElement</a></li><li data-type='method'><a href="app.module_core.html#~setExtensionDialog">setExtensionDialog</a></li><li data-type='method'><a href="app.module_core.html#~setLang">setLang</a></li><li data-type='method'><a href="app.module_core.html#~setLangs">setLangs</a></li><li data-type='method'><a href="app.module_core.html#~setUniq">setUniq</a></li><li data-type='method'><a href="app.module_core.html#~whatsThat">whatsThat</a></li></ul></li><li><a href="app.module_ui.html">ui</a><ul class='methods'><li data-type='method'><a href="app.module_ui.html#~copyValueToFormIndex">copyValueToFormIndex</a></li><li data-type='method'><a href="app.module_ui.html#~copyValueToModelIndex">copyValueToModelIndex</a></li><li data-type='method'><a href="app.module_ui.html#~findValues">findValues</a></li><li data-type='method'><a href="app.module_ui.html#~initValueToFormIndex">initValueToFormIndex</a></li><li data-type='method'><a href="app.module_ui.html#~resestShowAdvance">resestShowAdvance</a></li><li data-type='method'><a href="app.module_ui.html#~setErrorMessage">setErrorMessage</a></li><li data-type='method'><a href="app.module_ui.html#~setExtent">setExtent</a></li><li data-type='method'><a href="app.module_ui.html#~showAdvance">showAdvance</a></li><li data-type='method'><a href="app.module_ui.html#~toggleAll">toggleAll</a></li><li data-type='method'><a href="app.module_ui.html#~toggleSection">toggleSection</a></li><li data-type='method'><a href="app.module_ui.html#~updateLinkValues">updateLinkValues</a></li></ul></li><li><a href="app.ui.module_avBindValue.html">avBindValue</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avBindValue.html#~avBindValue">avBindValue</a></li></ul></li><li><a href="app.ui.module_avCompileHtml.html">avCompileHtml</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avCompileHtml.html#~avCompileHtml">avCompileHtml</a></li></ul></li><li><a href="app.ui.module_avContentPanel.html">avContentPanel</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avContentPanel.html#~addHeaderControl">addHeaderControl</a></li><li data-type='method'><a href="app.ui.module_avContentPanel.html#~initFooter">initFooter</a></li><li data-type='method'><a href="app.ui.module_avContentPanel.html#~link">link</a></li></ul></li><li><a href="app.ui.module_avHeader.html">avHeader</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avHeader.html#~avHeader">avHeader</a></li><li data-type='method'><a href="app.ui.module_avHeader.html#~create">create</a></li><li data-type='method'><a href="app.ui.module_avHeader.html#~filesSubmitted">filesSubmitted</a></li><li data-type='method'><a href="app.ui.module_avHeader.html#~getTemplates">getTemplates</a></li><li data-type='method'><a href="app.ui.module_avHeader.html#~save">save</a></li><li data-type='method'><a href="app.ui.module_avHeader.html#~save">save</a></li><li data-type='method'><a href="app.ui.module_avHeader.html#~setLanguage">setLanguage</a></li><li data-type='method'><a href="app.ui.module_avHeader.html#~setTemplate">setTemplate</a></li></ul></li><li><a href="app.ui.module_avLanguage.html">avLanguage</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avLanguage.html#~avLanguage">avLanguage</a></li></ul></li><li><a href="app.ui.module_avMap.html">avMap</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avMap.html#~avMap">avMap</a></li><li data-type='method'><a href="app.ui.module_avMap.html#~setCollapsibleHeader">setCollapsibleHeader</a></li><li data-type='method'><a href="app.ui.module_avMap.html#~setCollapsibleHeaderEntry">setCollapsibleHeaderEntry</a></li></ul></li><li><a href="app.ui.module_avServices.html">avServices</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avServices.html#~avServices">avServices</a></li></ul></li><li><a href="app.ui.module_avSummary.html">avSummary</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avSummary.html#~avSummary">avSummary</a></li><li data-type='method'><a href="app.ui.module_avSummary.html#~expandSummary">expandSummary</a></li><li data-type='method'><a href="app.ui.module_avSummary.html#~initState">initState</a></li><li data-type='method'><a href="app.ui.module_avSummary.html#~openPreview">openPreview</a></li><li data-type='method'><a href="app.ui.module_avSummary.html#~previewReady">previewReady</a></li><li data-type='method'><a href="app.ui.module_avSummary.html#~setSubTab">setSubTab</a></li><li data-type='method'><a href="app.ui.module_avSummary.html#~setSubTabID">setSubTabID</a></li><li data-type='method'><a href="app.ui.module_avSummary.html#~walkTree">walkTree</a></li></ul></li><li><a href="app.ui.module_avTab.html">avTab</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avTab.html#~avTab">avTab</a></li><li data-type='method'><a href="app.ui.module_avTab.html#~mapTabs">mapTabs</a></li></ul></li><li><a href="app.ui.module_avTest.html">avTest</a></li><li><a href="app.ui.module_avTree.html">avTree</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avTree.html#~avTree">avTree</a></li></ul></li><li><a href="app.ui.module_avUi.html">avUi</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avUi.html#~avUi">avUi</a></li><li data-type='method'><a href="app.ui.module_avUi.html#~getAboutChoice">getAboutChoice</a></li></ul></li><li><a href="app.ui.module_avVersion.html">avVersion</a><ul class='methods'><li data-type='method'><a href="app.ui.module_avVersion.html#~avVersion">avVersion</a></li></ul></li><li><a href="app.ui.module_dynamicSelect.html">dynamicSelect</a><ul class='methods'><li data-type='method'><a href="app.ui.module_dynamicSelect.html#~dynamicSelect">dynamicSelect</a></li></ul></li><li><a href="material.components.button.module_MdButtonDirectiveDecorator.html">MdButtonDirectiveDecorator</a><ul class='methods'><li data-type='method'><a href="material.components.button.module_MdButtonDirectiveDecorator.html#~decorateCompile">decorateCompile</a></li></ul></li><li><a href="material.components.tooltip.module_mdTooltipDirective.html">mdTooltipDirective</a><ul class='methods'><li data-type='method'><a href="material.components.tooltip.module_mdTooltipDirective.html#~decorateCompile">decorateCompile</a></li><li data-type='method'><a href="material.components.tooltip.module_mdTooltipDirective.html#~isTouch">isTouch</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="app.html">app</a></li><li><a href="app.addon.html">addon</a></li><li><a href="app.core.html">core</a><ul class='methods'><li data-type='method'><a href="app.core.html#.configBlock">configBlock</a></li><li data-type='method'><a href="app.core.html#.seed">seed</a></li><li data-type='method'><a href="app.core.html#~configureIconsets">configureIconsets</a></li><li data-type='method'><a href="app.core.html#~configureTheme">configureTheme</a></li><li data-type='method'><a href="app.core.html#~configureTranslations">configureTranslations</a></li></ul></li><li><a href="app.geo.html">geo</a></li><li><a href="app.layout.html">layout</a></li><li><a href="app.ui.html">ui</a></li></ul><h3>Global</h3><ul><li><a href="global.html#$on">$on</a></li><li><a href="global.html#applyDefault">applyDefault</a></li><li><a href="global.html#AV">AV</a></li><li><a href="global.html#avDefaults">avDefaults</a></li><li><a href="global.html#compile">compile</a></li><li><a href="global.html#configureParser">configureParser</a></li><li><a href="global.html#initLanguages">initLanguages</a></li><li><a href="global.html#initShortcut">initShortcut</a></li><li><a href="global.html#loadExtensions">loadExtensions</a></li><li><a href="global.html#uploadDefault">uploadDefault</a></li><li><a href="global.html#uploadSchema">uploadSchema</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">core/modelManager.service.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module modelManager
 * @memberof app.common
 * @description
 *
 * The `modelManager` factory is a service controlling schema and model content.
 *
 */
angular
    .module('app.core')
    .factory('modelManager', modelManager);

function modelManager($timeout, $translate, events, constants, commonService) {

    const service = {
        save,
        setSchema,
        getSchema,
        setModels,
        getModel,
        updateModel,
        setDefault
    };

    const _state = {};
    const _form = {};
    const _schema = {};
    const _model = {};

    let _default = {};

    return service;

    /*********/

    /**
     * Return the schema as a string to be save
     * @function save
     * @param {Boolean} preview [optional = false] if save is for preview
     * @return {String} the schema as a string to be save
     */
    function save(preview = false) {
        // loop schemas to get model values
        const models = { };
        constants.schemas.forEach(schema => {
            const name = schema.split('.')[0];
            models[name] = getModel(name, false);
        });

        // version and language are one item model so we have to recreate the string
        models.version = models.version.version;
        models.language = models.language.language;

        // FIXME: this is a workaround to parse the legend string to JSON objects
        // and set it back to string after save/preview
        let root = models.map.legend.root;
        if (typeof root === 'string') {
            models.map.legend.root = JSON.parse(root);
        }
        $timeout(() => {
            models.map.legend.root = JSON.stringify(models.map.legend.root, null, 4);
        }, 1000);

        // remove $$haskkey from model
        let cleanModels = commonService.parseJSON(models);

        modifyPropNames(cleanModels, 'SAVE');

        // return the config as a string
        return JSON.stringify(cleanModels);
    }

    /**
     * Delete colunms for a particular layer
     * @function deleteColumns
     * @private
     * @param {Object} entry model (layer) to clean
     * @return {Object} entry the clean entry with removed columns
     */
    function deleteColumns(entry) {
        // if there is table and columns define, remove the one with remove = true
        if (typeof entry.table !== 'undefined' &amp;&amp; typeof entry.table.columns !== 'undefined') {
            entry.table.columns = entry.table.columns.filter(item => !item.remove);
        }

        return entry;
    }

    /**
     * Set initial schema
     * @function setSchema
     * @param {String} modelName the model/form name to set schema for
     * @param {Object} schema the schema JSON object
     * @param {String} lang the language to set
     */
    function setSchema(modelName, schema, lang) {
        if (!_schema[lang]) {
            _schema[lang] = {};
        }
        _schema[lang][modelName] = schema;
    }

    /**
     * Get the schema for a model/form
     * @function getSchema
     * @param {String} modelName the model/form name to get schema for
     * @return {String}          the schema
     */
    function getSchema(modelName) {
        return _schema[commonService.getLang()][modelName];
    }

    /**
     * Set all the models when user load an existing config file
     * @function setModels
     * @param {Object} models all the models loaded from the configuration file in JSON
     */
    function setModels(models) {
        $.each(models, (k, v) => { _model[k] = v; });

        // broadcast event so form can update themselves
        events.$broadcast(events.avLoadModel);
    }

    /**
     * Get a model
     * @function getSchema
     * @param {String} modelName the model/form name to get model for
     * @param {String} newModel optional: true if it is a new model so we apply default
     * @return {Object}          the model
     */
    function getModel(modelName, newModel = true) {
        // if it is a new model, we apply default configuration value
        // check if it is only a string (version and language) and return default values
        // it is { map: {..}, version: "en-ca" } we need to set it { map: {..}, version: { version: "en-ca" } }
        _model[modelName] = (newModel) ? applyDefault(modelName, {}) :
            (typeof _model[modelName] !== 'string') ? _model[modelName] : { [modelName]: _model[modelName] };

        modifyPropNames(_model, 'LOAD');

        return _model[modelName];
    }

    /**
     * Update model after avLoadModel events
     * @function updateModel
     * @param {Object} scope controller scope
     * @param {String} modelName the model/form name to update model
     */
    function updateModel(scope, modelName) {
        scope.model = getModel(modelName, false);

        modifyPropNames(scope.model, 'LOAD');

        scope.$broadcast('schemaFormValidate');
        // TODO: when summary panel will work again, re-enable validation
        // $timeout(() => { validateModel(modelName, scope.activeForm); }, 1000);
    }

    /**
     * modify properties name entitled 'value'
     * 'value' has specific meaning for Angular Schema Form
     * @function modifyPropNames
     * @param {Object} model model
     * @param {String} mode mode 'LOAD'|'SAVE'
     */
    function modifyPropNames(model, mode) {

        // For the moment just some 'value' properties are modified
        const paths = [['services','export','title'], ['services','export','footnote']];

        const propNames = { LOAD: ['value', 'value'], SAVE: ['titleValue', 'footnoteValue']};

        for (let [i, item] of paths.entries()) {
            let obj = commonService.getNested (model, item);
            if (obj !== undefined &amp;&amp; obj.hasOwnProperty(propNames[mode][i])) {
                const conv = mode === 'LOAD' ? 'SAVE' : 'LOAD';
                obj[propNames[conv][i]] = obj[propNames[mode][i]];
                delete obj[propNames[mode][i]];
            }
        }
    }

    /**
     * Apply default configuration to a model
     * @function applyDefault
     * @private
     * @param {String} modelName the model/form name to apply default on
     * @param {Object} model the model
     * @return {Object}      updated model
     */
    function applyDefault(modelName, model) {
        // get default model values
        const defaultModel = _default[modelName];

        // check if it is only a string (version and language) and return default values
        // it is { map: {..}, version: "en-ca" } we need to set it { map: {..}, version: { version: "en-ca" } }
        const defaults = (typeof defaultModel !== 'string') ?
            $.extend(true, model, _default[modelName]) : { [modelName]: defaultModel };

        return defaults;
    }

    /**
     * Set default configuration values to apply on new model
     * @function setDefault
     * @param {Object} defaultValues the default values in JSON
     */
    function setDefault(defaultValues) {
        _default = defaultValues;
    }
}</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Feb 15 2018 14:54:04 GMT-0500 (EST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
